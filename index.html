<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>AJXT Burn Tool</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>

  <!-- Solana Web3 (IIFE) -->
  <script src="https://unpkg.com/@solana/web3.js@latest/lib/index.iife.min.js"></script>

  <style>
    :root{
      --bg:#0b0b0b; --panel:#151515; --text:#fff; --muted:#a9a9a9;
      --ok:#00c853; --danger:#d50000; --field:#f4f4f4; --fieldText:#101010;
      --radius:14px;
    }
    body{font-family:Arial,sans-serif;background:var(--bg);color:var(--text);
      display:flex;justify-content:center;align-items:center;min-height:100vh;margin:0;padding:24px;}
    .box{background:var(--panel);padding:22px;border-radius:var(--radius);width:min(420px,94vw);
      box-shadow:0 10px 30px rgba(0,0,0,.35);}
    h2{margin:2px 0 14px;font-size:22px;}
    .badge{display:inline-block;padding:4px 8px;border-radius:999px;background:rgba(0,200,83,.16);
      color:#b9ffcf;font-size:12px;margin-left:8px;vertical-align:middle;}
    button{width:100%;padding:12px 14px;margin-top:10px;font-size:16px;border-radius:10px;border:none;
      cursor:pointer;font-weight:700;}
    .primary{background:var(--ok);color:#000;}
    .danger{background:var(--danger);color:#fff;}
    .secondary{background:#2a2a2a;color:#fff;}
    input{width:100%;padding:11px 12px;margin-top:10px;border-radius:10px;border:none;font-size:16px;
      background:var(--field);color:var(--fieldText);box-sizing:border-box;}
    .row{display:flex;gap:10px;align-items:center;margin-top:10px;}
    .row>button{margin-top:0;width:auto;flex:1;}
    .status{margin-top:10px;font-size:13px;color:var(--muted);line-height:1.35;word-break:break-word;}
    .hr{height:1px;background:rgba(255,255,255,.08);margin:14px 0;border-radius:999px;}
    .small{font-size:12px;color:var(--muted);margin-top:10px;line-height:1.35;}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;}
  </style>
</head>

<body>
  <div class="box">
    <h2>AJXT Burn Tool <span class="badge">SPL Burn</span></h2>

    <button class="primary" id="btnConnect">Connect Wallet</button>

    <div class="status" id="walletLine">Wallet not connected</div>
    <div class="status" id="balanceLine">AJXT balance: —</div>

    <div class="hr"></div>

    <input id="amount" inputmode="decimal" placeholder="Amount to burn (e.g. 1.5)" />

    <div class="row">
      <button class="secondary" id="btnMax">Max</button>
      <button class="danger" id="btnBurn">Burn Tokens</button>
    </div>

    <div class="status" id="status">Ready.</div>

    <div class="small">
      <b>Warning:</b> Burn is irreversible. You confirm the transaction in Phantom.
    </div>
  </div>

<script>
(() => {
  const { Connection, PublicKey, Transaction, TransactionInstruction, SystemProgram } = solanaWeb3;

  // ===== CONFIG =====
  const RPC = "https://api.mainnet-beta.solana.com";
  const connection = new Connection(RPC, "confirmed");

  const MINT = new PublicKey("HE21tN94f1sY9PABezLsqkXJe5uXP8VA4SPrE82i");
  const DECIMALS = 9;

  const TOKEN_PROGRAM_ID = new PublicKey("TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA");
  const ASSOCIATED_TOKEN_PROGRAM_ID = new PublicKey("ATokenGPvbdGVxr1b2hvZbsiqW5xWH25efTNsLJA8knL");
  const RENT_SYSVAR_ID = new PublicKey("SysvarRent111111111111111111111111111111111");

  // ===== STATE =====
  let provider = null;
  let walletPubkey = null;
  let cachedATA = null;
  let cachedUiBalance = 0;

  // ===== UI =====
  const el = (id) => document.getElementById(id);
  const setStatus = (s) => el("status").innerText = s;

  function disable(btnId, v){
    const b = el(btnId);
    b.disabled = v;
    b.style.opacity = v ? 0.6 : 1;
    b.style.cursor = v ? "not-allowed" : "pointer";
  }

  function getProvider(){
    const p = (window.phantom && window.phantom.solana) ? window.phantom.solana : window.solana;
    return (p && p.isPhantom) ? p : null;
  }

  // ===== helpers =====
  function pow10(n){ let x=1n; for(let i=0;i<n;i++) x*=10n; return x; }

  function parseUiToBaseUnits(uiStr, decimals){
    const s = (uiStr || "").trim();
    if(!s) throw new Error("Enter amount");
    if(!/^\d+(\.\d+)?$/.test(s)) throw new Error("Invalid number format");
    const [whole, fracRaw=""] = s.split(".");
    const frac = (fracRaw + "0".repeat(decimals)).slice(0, decimals);
    const base = BigInt(whole) * pow10(decimals) + BigInt(frac || "0");
    if(base <= 0n) throw new Error("Amount must be > 0");
    return base;
  }

  function u64ToLeBytes(x){
    let v = BigInt(x);
    const out = new Uint8Array(8);
    for(let i=0;i<8;i++){ out[i] = Number(v & 0xffn); v >>= 8n; }
    return out;
  }

  function getATA(owner, mint){
    const [ata] = PublicKey.findProgramAddressSync(
      [owner.toBuffer(), TOKEN_PROGRAM_ID.toBuffer(), mint.toBuffer()],
      ASSOCIATED_TOKEN_PROGRAM_ID
    );
    return ata;
  }

  function ixCreateATA(payer, owner, mint, ata){
    // Associated Token Account program create instruction has empty data
    return new TransactionInstruction({
      programId: ASSOCIATED_TOKEN_PROGRAM_ID,
      keys: [
        { pubkey: payer, isSigner: true,  isWritable: true  },
        { pubkey: ata,   isSigner: false, isWritable: true  },
        { pubkey: owner, isSigner: false, isWritable: false },
        { pubkey: mint,  isSigner: false, isWritable: false },
        { pubkey: SystemProgram.programId, isSigner: false, isWritable: false },
        { pubkey: TOKEN_PROGRAM_ID,        isSigner: false, isWritable: false },
        { pubkey: RENT_SYSVAR_ID,          isSigner: false, isWritable: false },
      ],
      data: new Uint8Array([]),
    });
  }

  function ixBurn(ata, mint, owner, amountBase){
    // SPL Token Program: Burn = instruction 8 + u64 amount (LE)
    const data = new Uint8Array(1 + 8);
    data[0] = 8;
    data.set(u64ToLeBytes(amountBase), 1);

    return new TransactionInstruction({
      programId: TOKEN_PROGRAM_ID,
      keys: [
        { pubkey: ata,   isSigner: false, isWritable: true  },
        { pubkey: mint,  isSigner: false, isWritable: true  },
        { pubkey: owner, isSigner: true,  isWritable: false },
      ],
      data
    });
  }

  async function refreshBalance(){
    if(!walletPubkey) return;
    cachedATA = getATA(walletPubkey, MINT);

    const info = await connection.getParsedAccountInfo(cachedATA);
    if(!info || !info.value){
      cachedUiBalance = 0;
      el("balanceLine").innerText = "AJXT balance: 0 (ATA not created yet)";
      return;
    }
    const uiAmount = info.value.data?.parsed?.info?.tokenAmount?.uiAmount ?? 0;
    cachedUiBalance = Number(uiAmount) || 0;
    el("balanceLine").innerText = `AJXT balance: ${cachedUiBalance}`;
  }

  async function connectWallet(){
    try{
      provider = getProvider();
      if(!provider){
        alert("Phantom wallet not found (extension).");
        setStatus("Phantom not detected.");
        return;
      }

      setStatus("Requesting Phantom connection…");
      await provider.connect({ onlyIfTrusted: false });

      if(!provider.publicKey){
        setStatus("Connected, but no publicKey exposed. Refresh and try again.");
        alert("Connected, but no publicKey returned. Refresh page and try again.");
        return;
      }

      walletPubkey = provider.publicKey;
      el("walletLine").innerHTML = `Connected: <span class="mono">${walletPubkey.toString()}</span>`;
      el("btnConnect").innerText = "Wallet Connected";
      el("btnConnect").disabled = true;
      el("btnConnect").style.opacity = 0.8;

      setStatus("Fetching AJXT balance…");
      await refreshBalance();
      setStatus("Ready.");
    }catch(e){
      console.error(e);
      setStatus("Connect failed: " + (e?.message || e));
    }
  }

  function fillMax(){
    if(!walletPubkey){ alert("Connect wallet first"); return; }
    el("amount").value = String(cachedUiBalance || 0);
  }

  async function burn(){
    try{
      if(!walletPubkey){ alert("Connect wallet first"); return; }
      disable("btnBurn", true);

      const amountBase = parseUiToBaseUnits(el("amount").value, DECIMALS);
      const ata = cachedATA || getATA(walletPubkey, MINT);

      const ixs = [];
      const ataInfo = await connection.getAccountInfo(ata);
      if(!ataInfo){
        setStatus("Creating token account (ATA)…");
        ixs.push(ixCreateATA(walletPubkey, walletPubkey, MINT, ata));
      }

      ixs.push(ixBurn(ata, MINT, walletPubkey, amountBase));

      const tx = new Transaction().add(...ixs);
      tx.feePayer = walletPubkey;

      const { blockhash, lastValidBlockHeight } = await connection.getLatestBlockhash("confirmed");
      tx.recentBlockhash = blockhash;

      provider = provider || getProvider();
      if(!provider){ throw new Error("Phantom not detected"); }

      setStatus("Confirm burn in Phantom…");
      const res = await provider.signAndSendTransaction(tx);
      const sig = res.signature;

      setStatus("Sent. Confirming…");
      await connection.confirmTransaction({ signature: sig, blockhash, lastValidBlockHeight }, "confirmed");

      setStatus("Burn confirmed ✅ Signature: " + sig);
      await refreshBalance();
    }catch(e){
      console.error(e);
      setStatus("Failed: " + (e?.message || e));
    }finally{
      disable("btnBurn", false);
    }
  }

  // Bind buttons
  el("btnConnect").addEventListener("click", connectWallet);
  el("btnMax").addEventListener("click", fillMax);
  el("btnBurn").addEventListener("click", burn);

})();
</script>
</body>
</html>
